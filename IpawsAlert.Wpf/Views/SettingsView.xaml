<UserControl x:Class="IpawsAlert.Wpf.Views.SettingsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:IpawsAlert.Wpf.Converters"
             Background="{StaticResource Brush.Bg.Shell}">

    <UserControl.Resources>
        <conv:BoolToVisConverter        x:Key="BoolToVis"/>
        <conv:InverseBoolToVisConverter x:Key="InvBoolToVis"/>
    </UserControl.Resources>

    <DockPanel>

        <!-- Header -->
        <Border DockPanel.Dock="Top"
                Background="{StaticResource Brush.Bg.Panel}"
                BorderBrush="{StaticResource Brush.Border.Default}"
                BorderThickness="0,0,0,1"
                Padding="20,14">
            <StackPanel>
                <TextBlock Text="Settings"
                           FontSize="{StaticResource Font.Size.Xl}"
                           FontWeight="SemiBold"
                           Foreground="{StaticResource Brush.Text.Primary}"/>
                <TextBlock Text="Configure IPAWS-OPEN connection, certificate, and UI preferences."
                           FontSize="{StaticResource Font.Size.Sm}"
                           Foreground="{StaticResource Brush.Text.Secondary}"
                           Margin="0,3,0,0"/>
            </StackPanel>
        </Border>

        <!-- Scrollable settings body -->
        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <StackPanel MaxWidth="620" HorizontalAlignment="Left" Margin="20,20,20,20">

                <!-- ── Section: COG / Sender ─────────────────────────────── -->
                <Border Style="{StaticResource Style.Card}">
                    <StackPanel>
                        <TextBlock Text="SENDER IDENTITY" Style="{StaticResource Style.SectionHeading}"/>

                        <TextBlock Text="COG Identifier (issued by FEMA)"
                                   Style="{StaticResource Style.FieldLabel}"/>
                        <TextBox Text="{Binding CogId, UpdateSourceTrigger=PropertyChanged}"
                                 Height="28" Margin="0,0,0,10"/>

                        <TextBlock Text="Sender Email Address (e.g. alerts@agency.gov)"
                                   Style="{StaticResource Style.FieldLabel}"/>
                        <TextBox Text="{Binding SenderAddress, UpdateSourceTrigger=PropertyChanged}"
                                 Height="28" Margin="0,0,0,10"/>

                        <TextBlock Text="Sender Display Name (optional)"
                                   Style="{StaticResource Style.FieldLabel}"/>
                        <TextBox Text="{Binding SenderName, UpdateSourceTrigger=PropertyChanged}"
                                 Height="28"/>
                    </StackPanel>
                </Border>

                <!-- ── Section: Endpoint ─────────────────────────────────── -->
                <Border Style="{StaticResource Style.Card}">
                    <StackPanel>
                        <TextBlock Text="ENDPOINT" Style="{StaticResource Style.SectionHeading}"/>

                        <CheckBox Content="Use Testing / JITC endpoint (recommended for testing)"
                                  IsChecked="{Binding UseTestEndpoint}"
                                  Margin="0,0,0,8"/>

                        <Border Background="{StaticResource Brush.Bg.Input}"
                                BorderBrush="{StaticResource Brush.Border.Default}"
                                BorderThickness="1" CornerRadius="3"
                                Padding="10,8">
                            <StackPanel>
                                <TextBlock Text="Active Endpoint:"
                                           Style="{StaticResource Style.FieldLabel}"
                                           Margin="0,0,0,2"/>
                                <TextBlock Text="{Binding ActiveEndpointLabel}"
                                           FontFamily="{StaticResource Font.Mono}"
                                           FontSize="{StaticResource Font.Size.Xs}"
                                           Foreground="{StaticResource Brush.Accent.Blue}"
                                           TextWrapping="Wrap"/>
                            </StackPanel>
                        </Border>

                        <Border Background="#1A2A0A" BorderBrush="#2A4A1A"
                                BorderThickness="1" CornerRadius="3" Padding="10,8"
                                Margin="0,8,0,0"
                                Visibility="{Binding UseTestEndpoint, Converter={StaticResource InvBoolToVis}}">
                            <TextBlock TextWrapping="Wrap"
                                       FontSize="{StaticResource Font.Size.Sm}"
                                       Foreground="#FF9500">
                                ⚠  PRODUCTION endpoint is selected. Alerts submitted will trigger
                                real public broadcasts. Ensure Status = "Actual" only for genuine emergencies.
                            </TextBlock>
                        </Border>
                    </StackPanel>
                </Border>

                <!-- ── Section: Certificate ──────────────────────────────── -->
                <Border Style="{StaticResource Style.Card}">
                    <StackPanel>
                        <TextBlock Text="mTLS CERTIFICATE (FEMA-ISSUED)"
                                   Style="{StaticResource Style.SectionHeading}"/>

                        <StackPanel Margin="0,0,0,12">
                            <RadioButton Content="Load from .p12 / .pfx file"
                                         IsChecked="{Binding UseFileMode}"
                                         Foreground="{StaticResource Brush.Text.Primary}"
                                         FontSize="{StaticResource Font.Size.Base}"
                                         Margin="0,0,0,4"/>
                            <RadioButton Content="Load from Windows Certificate Store (by thumbprint)"
                                         IsChecked="{Binding UseCertStore}"
                                         Foreground="{StaticResource Brush.Text.Primary}"
                                         FontSize="{StaticResource Font.Size.Base}"/>
                        </StackPanel>

                        <!-- File mode -->
                        <StackPanel Visibility="{Binding UseFileMode, Converter={StaticResource BoolToVis}}">
                            <TextBlock Text="Certificate File Path (.p12 / .pfx)"
                                       Style="{StaticResource Style.FieldLabel}"/>
                            <Grid Margin="0,0,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox Grid.Column="0"
                                         Text="{Binding CertPath, UpdateSourceTrigger=PropertyChanged}"
                                         Height="28" Margin="0,0,6,0"
                                         FontFamily="{StaticResource Font.Mono}"
                                         FontSize="{StaticResource Font.Size.Sm}"/>
                                <Button Grid.Column="1"
                                        Content="Browse…"
                                        Command="{Binding BrowseCertCommand}"
                                        Style="{StaticResource Style.Button.Secondary}"
                                        Height="28" Padding="12,0"/>
                            </Grid>

                            <TextBlock Text="Certificate Password"
                                       Style="{StaticResource Style.FieldLabel}"/>
                            <PasswordBox x:Name="CertPasswordBox"
                                         Height="28"
                                         PasswordChanged="CertPasswordBox_PasswordChanged"/>
                            <TextBlock Text="Password is stored in memory only and cleared on exit."
                                       FontSize="{StaticResource Font.Size.Xs}"
                                       Foreground="{StaticResource Brush.Text.Muted}"
                                       Margin="0,4,0,0"/>
                        </StackPanel>

                        <!-- Store mode -->
                        <StackPanel Visibility="{Binding UseCertStore, Converter={StaticResource BoolToVis}}">
                            <TextBlock Text="Certificate Thumbprint (SHA-1, no spaces)"
                                       Style="{StaticResource Style.FieldLabel}"/>
                            <TextBox Text="{Binding CertThumbprint, UpdateSourceTrigger=PropertyChanged}"
                                     Height="28"
                                     FontFamily="{StaticResource Font.Mono}"
                                     FontSize="{StaticResource Font.Size.Sm}"/>
                            <TextBlock Text="The certificate must be in CurrentUser\Personal or LocalMachine\Personal."
                                       FontSize="{StaticResource Font.Size.Xs}"
                                       Foreground="{StaticResource Brush.Text.Muted}"
                                       TextWrapping="Wrap"
                                       Margin="0,4,0,0"/>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- ── Section: Preferences ──────────────────────────────── -->
                <Border Style="{StaticResource Style.Card}">
                    <StackPanel>
                        <TextBlock Text="UI PREFERENCES" Style="{StaticResource Style.SectionHeading}"/>
                        <CheckBox Content="Require confirmation before sending Actual alerts"
                                  IsChecked="{Binding ConfirmBeforeSend}"
                                  Margin="0,0,0,10"/>
                        <CheckBox Content="Show live CAP XML preview while composing"
                                  IsChecked="{Binding ShowXmlPreview}"/>
                    </StackPanel>
                </Border>

                <!-- Save button + status -->
                <StackPanel Orientation="Horizontal">
                    <Button Content="Save Settings"
                            Command="{Binding SaveCommand}"
                            Style="{StaticResource Style.Button.Primary}"
                            Width="140" Margin="0,0,12,0"/>
                    <TextBlock Text="{Binding SaveStatus}"
                               VerticalAlignment="Center"
                               FontSize="{StaticResource Font.Size.Sm}"
                               Foreground="{StaticResource Brush.Status.Success}"/>
                </StackPanel>

            </StackPanel>
        </ScrollViewer>
    </DockPanel>
</UserControl>
