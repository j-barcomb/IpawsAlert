<UserControl x:Class="IpawsAlert.Wpf.Views.HistoryView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:IpawsAlert.Wpf.Converters"
             Background="{StaticResource Brush.Bg.Shell}">

    <UserControl.Resources>
        <conv:BoolToVisConverter        x:Key="BoolToVis"/>
        <conv:InverseBoolToVisConverter x:Key="InvBoolToVis"/>
        <conv:SuccessToBrushConverter   x:Key="SuccessBrush"/>
        <conv:CapStatusToBrushConverter x:Key="CapStatusBrush"/>
        <conv:NullToCollapseConverter   x:Key="NullCollapse"/>
    </UserControl.Resources>

    <DockPanel>

        <!-- Header -->
        <Border DockPanel.Dock="Top"
                Background="{StaticResource Brush.Bg.Panel}"
                BorderBrush="{StaticResource Brush.Border.Default}"
                BorderThickness="0,0,0,1" Padding="20,14">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel Grid.Column="0" VerticalAlignment="Center">
                    <TextBlock Text="Submission History"
                               FontSize="{StaticResource Font.Size.Xl}" FontWeight="SemiBold"
                               Foreground="{StaticResource Brush.Text.Primary}"/>
                    <TextBlock Foreground="{StaticResource Brush.Text.Secondary}"
                               FontSize="{StaticResource Font.Size.Sm}" Margin="0,2,0,0">
                        <TextBlock.Text>
                            <Binding Path="Entries.Count" StringFormat="{}{0} alerts in session"/>
                        </TextBlock.Text>
                    </TextBlock>
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Content="Copy XML"
                            Command="{Binding CopyXmlCommand}"
                            Style="{StaticResource Style.Button.Secondary}"
                            Margin="0,0,8,0"/>
                    <Button Content="Clear All"
                            Command="{Binding ClearHistoryCommand}"
                            Style="{StaticResource Style.Button.Secondary}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Empty state â€” shown when HasNoEntries is true -->
        <Border DockPanel.Dock="Top" Padding="40"
                Visibility="{Binding HasNoEntries, Converter={StaticResource BoolToVis}}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <TextBlock Text="No alerts sent yet"
                           FontSize="{StaticResource Font.Size.Lg}"
                           Foreground="{StaticResource Brush.Text.Muted}"
                           HorizontalAlignment="Center"/>
                <TextBlock Text="Alerts you submit will appear here with their full CAP XML."
                           FontSize="{StaticResource Font.Size.Base}"
                           Foreground="{StaticResource Brush.Text.Muted}"
                           HorizontalAlignment="Center" Margin="0,6,0,0"/>
            </StackPanel>
        </Border>

        <!-- Table + detail split -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="420"/>
            </Grid.ColumnDefinitions>

            <!-- DataGrid -->
            <DataGrid Grid.Column="0"
                      ItemsSource="{Binding Entries}"
                      SelectedItem="{Binding Selected}">
                <DataGrid.Columns>

                    <DataGridTemplateColumn Header="STATUS" Width="110">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="4,0">
                                    <Ellipse Width="7" Height="7" Margin="0,0,6,0">
                                        <Ellipse.Fill>
                                            <Binding Path="IsSuccess" Converter="{StaticResource SuccessBrush}"/>
                                        </Ellipse.Fill>
                                    </Ellipse>
                                    <TextBlock Text="{Binding StatusLabel}"
                                               FontSize="{StaticResource Font.Size.Sm}">
                                        <TextBlock.Foreground>
                                            <Binding Path="IsSuccess" Converter="{StaticResource SuccessBrush}"/>
                                        </TextBlock.Foreground>
                                    </TextBlock>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTemplateColumn Header="CAP STATUS" Width="80">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border CornerRadius="8" Padding="6,2" HorizontalAlignment="Left" Margin="4,2">
                                    <Border.Background>
                                        <Binding Path="CapStatus" Converter="{StaticResource CapStatusBrush}"/>
                                    </Border.Background>
                                    <TextBlock Text="{Binding CapStatus}"
                                               FontSize="10" FontWeight="Bold" Foreground="White"/>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTextColumn Header="EVENT TYPE" Binding="{Binding EventType}" Width="150"/>
                    <DataGridTextColumn Header="HEADLINE"   Binding="{Binding Headline}"  Width="*"/>
                    <DataGridTextColumn Header="CHANNELS"   Binding="{Binding Channels}"  Width="90"/>
                    <DataGridTextColumn Header="SUBMITTED"  Binding="{Binding SubmittedAtLocal}" Width="140"/>
                    <DataGridTextColumn Header="ELAPSED"    Binding="{Binding ElapsedLabel}" Width="80"/>

                </DataGrid.Columns>
            </DataGrid>

            <!-- Detail pane -->
            <Grid Grid.Column="1" Background="{StaticResource Brush.Bg.Panel}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <Border Grid.Row="0" Padding="16,12"
                        BorderBrush="{StaticResource Brush.Border.Default}"
                        BorderThickness="1,0,0,1">
                    <StackPanel Visibility="{Binding Selected, Converter={StaticResource NullCollapse}}">
                        <TextBlock Text="{Binding Selected.EventType}"
                                   FontSize="{StaticResource Font.Size.Md}" FontWeight="SemiBold"
                                   Foreground="{StaticResource Brush.Text.Primary}"/>
                        <TextBlock Text="{Binding Selected.AlertId}"
                                   FontFamily="{StaticResource Font.Mono}"
                                   FontSize="{StaticResource Font.Size.Xs}"
                                   Foreground="{StaticResource Brush.Text.Muted}"
                                   Margin="0,3,0,0"/>
                        <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                            <TextBlock Text="Server ID: "
                                       FontSize="{StaticResource Font.Size.Xs}"
                                       Foreground="{StaticResource Brush.Text.Secondary}"/>
                            <TextBlock Text="{Binding Selected.ServerMsgId}"
                                       FontFamily="{StaticResource Font.Mono}"
                                       FontSize="{StaticResource Font.Size.Xs}"
                                       Foreground="{StaticResource Brush.Text.Primary}"/>
                        </StackPanel>
                        <!-- Error summary: shown when the selected entry failed -->
                        <TextBlock Text="{Binding SelectedErrors}"
                                   FontSize="{StaticResource Font.Size.Xs}"
                                   Foreground="{StaticResource Brush.Status.Error}"
                                   TextWrapping="Wrap" Margin="0,4,0,0"
                                   Visibility="{Binding SelectedHasError, Converter={StaticResource BoolToVis}}"/>
                    </StackPanel>
                </Border>

                <ScrollViewer Grid.Row="1"
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Auto">
                    <TextBox Text="{Binding SelectedXml, Mode=OneWay}"
                             Style="{StaticResource Style.TextBox.Mono}"
                             FontSize="10" IsReadOnly="True" TextWrapping="NoWrap"
                             BorderThickness="1,0,0,0"
                             BorderBrush="{StaticResource Brush.Border.Default}"
                             Background="Transparent" Padding="14,12"
                             VerticalAlignment="Top"/>
                </ScrollViewer>
            </Grid>

            <GridSplitter Grid.Column="0" Width="4" HorizontalAlignment="Right"
                          Background="{StaticResource Brush.Border.Default}" Cursor="SizeWE"/>
        </Grid>
    </DockPanel>
</UserControl>
